/**
 * Server Side Rendering
 */
import { APIGatewayEvent } from 'aws-lambda';
import * as React from 'react';
import { renderToString } from 'react-dom/server';

import App           from '../App';
import ConfigContext from '../components/ConfigContext';
import config        from './config';
import html          from './html';
import { Stats }     from './types';

export type Type_render_args = APIGatewayEvent;
export type Type_render_ret  = Promise<string>;

/**
 * Server-side rendering
 */
export default async function render( event: Type_render_args ): Type_render_ret { // eslint-disable-line @typescript-eslint/no-unused-vars,@typescript-eslint/require-await
	// The stats are generated by the Webpack Stats Plugin (`webpack-stats-plugin`)
	// TODO: replace dummy with real
	const stats = (await import( '../../dist/stats.json' ) ).default as unknown as Stats; // ts-eslint does not like variables as an import argument
	//const stats = {
	//	scripts: [],
	//	styles:  [],
	//};
	//const stats = (await import( '../../stats.json' ) ).default as unknown as Stats; // ts-eslint does not like variables as an import argument
	//console.log( "Stats: ", { t: typeof stats, str: JSON.stringify(stats) } );
	const content = renderToString(
		<ConfigContext.Provider value={config}>
			<App/>
		</ConfigContext.Provider>,
	);
	//console.log('render: rendered content: [', content, ']');
	return html({ stats, content, config });
}
